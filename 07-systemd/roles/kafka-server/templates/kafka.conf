UserParameter=kafka.collect.consumers.lag[*],for i in $(kafka-consumer-groups --bootstrap-server $1:$2 --list 2>/dev/null);do kafka-consumer-groups --bootstrap-server $1:9093 --describe --command-config {{ kafka_conf_path }}/{{ kafka_zaabix_jaas_config_file }} --group $i 2>/dev/null | grep "[a-z]" | awk -v group=$i '{print group" "$$1" "$$2" "$$5}';done > /tmp/zabbix.kafka.consumer.lag ; echo $?
{% raw %}UserParameter=kafka.discovery.consumers.lag,awk 'BEGIN {i=0;print "{\"data\":["} {group[i]=$1;part[i]=$3;topic[i]=$2;++i} END {for (j=0;j<i-1;++j) {print "{\"{#PARTITION}\":\""part[j]"\",\"{#TOPIC}\":\""topic[j]"\",\"{#GROUP}\":\""group[j]"\"},"};print "{\"{#PARTITION}\":\""part[j]"\",\"{#TOPIC}\":\""topic[j]"\",\"{#GROUP}\":\""group[j]"\"}]}"}' /tmp/zabbix.kafka.consumer.lag{% endraw %}
UserParameter=kafka.consumers.lag[*],grep "^$1 $2 $3" /tmp/zabbix.kafka.consumer.lag | cut -d ' ' -f4
